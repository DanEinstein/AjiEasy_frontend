<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AjiEasy - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/app.css">
    <script>
        window.CONFIG = {
            API_URL: "https://ajieasy-backend.onrender.com",
            TOKEN_KEY: "aji_token",
            USER_KEY: "aji_user"
        };
    </script>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loadingMessage">Loading...</p>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button class="hamburger-menu" id="hamburgerMenu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <a href="index.html" class="brand">
                <i class="fas fa-rocket"></i>
                AjiEasy
            </a>
        </div>

        <div class="nav-right">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">User</span>
            </div>
            <button class="btn-logout" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Log Out</span>
            </button>
        </div>
    </nav>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="nav-section">
                <h3>Main Menu</h3>
                <div class="nav-links">
                    <button class="nav-link active" data-view="dashboard">
                        <i class="fas fa-home"></i> Dashboard
                    </button>
                    <button class="nav-link" data-view="questions">
                        <i class="fas fa-question-circle"></i> Interview Prep
                    </button>
                    <button class="nav-link" data-view="quiz">
                        <i class="fas fa-puzzle-piece"></i> Practice Quiz
                    </button>
                    <button class="nav-link" data-view="chat">
                        <i class="fas fa-comments"></i> AI Assistant
                    </button>
                </div>
            </div>

            <div class="nav-section">
                <h3>Insights</h3>
                <div class="nav-links">
                    <button class="nav-link" data-view="analytics">
                        <i class="fas fa-chart-bar"></i> Analytics
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">

            <!-- Dashboard View -->
            <div id="dashboardView" class="view-section active dashboard-view">
                <div class="welcome-header fade-in">
                    <h1 id="welcomeMessage">Welcome back!</h1>
                    <p>Ready to ace your next interview? Choose an activity below to get started.</p>
                </div>

                <!-- Trending Recommendations (Gemini Powered) -->
                <div class="recommendations-section fade-in" style="animation-delay: 0.1s;">
                    <h2 class="text-gradient" style="margin-bottom: 1.5rem; font-size: 1.5rem;">
                        <i class="fas fa-bolt" style="color: var(--warning);"></i> Trending in 2025
                    </h2>
                    <div class="rec-scroll" id="recommendationsList">
                        <div class="rec-card">
                            <i class="fas fa-spinner fa-spin"></i> Loading trends...
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid fade-in" style="animation-delay: 0.2s;">
                    <div class="action-card" data-view="questions">
                        <div class="card-icon icon-blue">
                            <i class="fas fa-magic"></i>
                        </div>
                        <h3>Generate Questions</h3>
                        <p>Get personalized interview questions based on your target role and company.</p>
                    </div>

                    <div class="action-card" data-view="quiz">
                        <div class="card-icon icon-teal">
                            <i class="fas fa-check-double"></i>
                        </div>
                        <h3>Take a Quiz</h3>
                        <p>Test your knowledge with interactive quizzes on various technical topics.</p>
                    </div>

                    <div class="action-card" data-view="chat">
                        <div class="card-icon icon-purple">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3>AI Chat Coach</h3>
                        <p>Have a conversation with our AI coach to practice your answers.</p>
                    </div>
                </div>

                <div class="recent-activity fade-in" style="animation-delay: 0.3s;">
                    <div class="section-header">
                        <h2>Recent Activity</h2>
                    </div>
                    <div class="activity-list" id="recentActivityList">
                        <!-- Populated by JS -->
                        <div class="activity-item">
                            <div class="activity-icon"><i class="fas fa-history"></i></div>
                            <div class="activity-details">
                                <div class="activity-title">No recent activity</div>
                                <div class="activity-meta">Start practicing to see your history here</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Questions View -->
            <div id="questionsView" class="view-section">
                <div class="section-header">
                    <h2>Interview Question Generator</h2>
                </div>

                <form id="topicForm">
                    <div class="input-group">
                        <label>Interview Topic</label>
                        <input type="text" name="topic" placeholder="e.g. React, Project Management" required>
                    </div>

                    <div class="input-group">
                        <label>Job Description / Role</label>
                        <input type="text" name="jobDescription" placeholder="e.g. Senior Frontend Developer" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="input-group">
                            <label>Interview Type</label>
                            <select name="interviewType">
                                <option value="Technical">Technical</option>
                                <option value="Behavioral">Behavioral</option>
                                <option value="HR">HR</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Company Type</label>
                            <select name="companyNature">
                                <option value="Startup">Startup</option>
                                <option value="Corporation">Corporation</option>
                                <option value="Remote">Remote</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">
                        <i class="fas fa-bolt"></i> Generate Questions
                    </button>
                </form>

                <div id="questionsResults" class="results-container" style="display: none;">
                    <!-- Results populated by JS -->
                </div>
            </div>

            <!-- Quiz View -->
            <div id="quizView" class="view-section">
                <div class="section-header">
                    <h2>Practice Quiz</h2>
                </div>

                <div id="quizSetup" class="fade-in">
                    <form id="quizForm">
                        <div class="input-group">
                            <label>Topic</label>
                            <input type="text" name="topic" placeholder="e.g. Python, System Design" required>
                        </div>
                        <div class="input-group">
                            <label>Difficulty</label>
                            <select name="difficulty">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary">
                    <p>Choose a feature from the left panel to get started with AI-powered interview preparation!</p>
                </div>

                <!-- Loading State -->
                <div class="loading-state hidden" id="loadingState">
                    <div class="spinner"></div>
                    <p id="loadingMessage">Generating your personalized questions...</p>
                </div>

                <!-- Questions Results State -->
                <div class="results-state" id="resultsState">
                    <div class="results-header">
                        <div class="results-header-left">
                            <h3>Interview Questions</h3>
                            <span class="topic-badge" id="topicBadge"></span>
                        </div>
                        <div class="results-actions">
                            <button class="btn-action favorite" id="saveFavoriteBtn" title="Save to favorites">
                                <i class="fas fa-star"></i>
                                Save
                            </button>
                            <button class="btn-action" id="downloadPdfBtn" title="Download as PDF">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                            <button class="btn-action" id="shareEmailBtn" title="Share via email">
                                <i class="fas fa-envelope"></i>
                                Email
                            </button>
                        </div>
                    </div>
                    <div class="results-content" id="resultsContent"></div>
                </div>

                <!-- Quiz Results State -->
                <div class="results-state" id="quizState">
                    <div class="results-header">
                        <div class="results-header-left">
                            <h3>Interactive Quiz</h3>
                            <span class="topic-badge" id="quizTopicBadge"></span>
                        </div>
                        <div class="results-actions">
                            <button class="btn-action" id="restartQuizBtn">
                                <i class="fas fa-redo"></i>
                                Restart
                            </button>
                        </div>
                    </div>
                    <div class="quiz-interface" id="quizInterface">
                        <!-- Quiz content will be loaded here -->
                    </div>
                </div>

                <!-- Chat State -->
                <div class="results-state" id="chatState">
                    <div class="results-header">
                        <div class="results-header-left">
                            <h3>AI Chat Assistant</h3>
                            <span class="topic-badge" id="chatTopicBadge">Ready to help!</span>
                        </div>
                        <div class="results-actions">
                            <button class="btn-action" id="clearChatBtn">
                                <i class="fas fa-broom"></i>
                                Clear Chat
                            </button>
                            <button class="btn-action favorite" id="saveChatBtn">
                                <i class="fas fa-save"></i>
                                Save Chat
                            </button>
                        </div>
                    </div>
                    <div class="chat-interface" id="chatInterface">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="chat-input-container" style="margin-top: 1rem; display: none;" id="chatInputContainer">
                        <div class="input-group">
                            <textarea id="continueChat" placeholder="Type your follow-up message..."
                                rows="2"></textarea>
                        </div>
                        <button class="btn-generate" id="continueChatBtn">
                            <i class="fas fa-paper-plane"></i>
                            Send
                        </button>
                    </div>
                </div>

                <!-- Analytics State -->
                <div class="results-state" id="analyticsState">
                    <div class="results-header">
                        <div class="results-header-left">
                            <h3>Performance Analytics</h3>
                            <span class="topic-badge" id="analyticsPeriodBadge">Last 30 Days</span>
                        </div>
                        <div class="results-actions">
                            <button class="btn-action" id="exportAnalyticsBtn">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="analytics-dashboard" id="analyticsDashboard">
                        <!-- Analytics charts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div>&copy; 2025 AjiEasy - AI Interview Preparation Platform</div>
            <div class="footer-links">
                <a href="#"><i class="fas fa-shield-alt"></i> Privacy Policy</a>
                <a href="#"><i class="fas fa-file-contract"></i> Terms of Service</a>
            </div>
        </div>
    </footer>

        <!-- Load authentication module -->
    <script src="auth.js"></script>

    <!-- Load jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- App page logic -->
    <script>
        // SECURITY: Check authentication immediately
        if (typeof checkAuth === 'function') {
            checkAuth();
        } else {
            console.warn('checkAuth function not found. Make sure auth.js is loaded.');
        }

        // API Configuration - UPDATED TO RENDER BACKEND
        const API_CONFIG = {
            baseURL: 'https://ajieasy-backend.onrender.com',
            endpoints: {
                generateQuestions: '/generate-questions/',
                generateQuiz: '/generate-quiz/',
                chat: '/chat/',
                analytics: '/analytics/',
                health: '/health'
            }
        };

        // Get references to DOM elements
        const topicForm = document.getElementById('topicForm');
        const quizForm = document.getElementById('quizForm');
        const topicInput = document.getElementById('topic');
        const jobDescriptionInput = document.getElementById('jobDescription');
        const interviewTypeSelect = document.getElementById('interviewType');
        const companyNatureSelect = document.getElementById('companyNature');
        const generateBtn = document.getElementById('generateBtn');
        const generateQuizBtn = document.getElementById('generateQuizBtn');
        const refreshAnalyticsBtn = document.getElementById('refreshAnalyticsBtn');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const continueChatBtn = document.getElementById('continueChatBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const saveChatBtn = document.getElementById('saveChatBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const displayPanel = document.getElementById('displayPanel');
        const initialState = document.getElementById('initialState');
        const loadingState = document.getElementById('loadingState');
        const loadingMessage = document.getElementById('loadingMessage');
        const resultsState = document.getElementById('resultsState');
        const quizState = document.getElementById('quizState');
        const chatState = document.getElementById('chatState');
        const analyticsState = document.getElementById('analyticsState');
        const topicBadge = document.getElementById('topicBadge');
        const quizTopicBadge = document.getElementById('quizTopicBadge');
        const chatTopicBadge = document.getElementById('chatTopicBadge');
        const analyticsPeriodBadge = document.getElementById('analyticsPeriodBadge');
        const resultsContent = document.getElementById('resultsContent');
        const quizInterface = document.getElementById('quizInterface');
        const chatInterface = document.getElementById('chatInterface');
        const analyticsDashboard = document.getElementById('analyticsDashboard');
        const historyList = document.getElementById('historyList');
        const toastContainer = document.getElementById('toastContainer');
        const userAvatar = document.getElementById('userAvatar');

        // Feature tabs
        const featureTabs = document.querySelectorAll('.feature-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Action buttons
        const saveFavoriteBtn = document.getElementById('saveFavoriteBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const shareEmailBtn = document.getElementById('shareEmailBtn');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const exportAnalyticsBtn = document.getElementById('exportAnalyticsBtn');

        // Current data storage
        let currentQuestions = [];
        let currentTopic = '';
        let currentJobDesc = '';
        let currentInterviewType = '';
        let currentCompanyNature = '';

        // Quiz state
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let quizScore = 0;

        // Chat state
        let chatHistory = [];

        // Get logout button
       const logoutButton = document.getElementById('logoutBtn');
        logoutButton.addEventListener('click', function (event) {
            event.preventDefault();
            if (typeof logoutUser === 'function') {
                logoutUser();
            } else {
                console.warn('logoutUser function not found. Make sure auth.js is loaded.');
                // Fallback logout - UPDATED TO MATCH auth.js
                localStorage.removeItem('accessToken');
                localStorage.removeItem('user');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                window.location.href = 'login.html';
            }
        });
        // Display user's name and avatar
        function getUserName() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            return user.name || '';
        }

        function getUserEmail() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            return user.email || '';
        }

        const userName = getUserName();
        const userEmail = getUserEmail();
        if (userName) {
            document.getElementById('userName').textContent = userName;
            userAvatar.textContent = userName.charAt(0).toUpperCase();
        } else if (userEmail) {
            const displayName = userEmail.split('@')[0];
            document.getElementById('userName').textContent = displayName;
            userAvatar.textContent = displayName.charAt(0).toUpperCase();
        }

        async function hydrateUserProfile() {
            if (userName || !window.fetchAndStoreCurrentUser) {
                return;
            }
            const profile = await fetchAndStoreCurrentUser();
            if (profile && profile.name) {
                document.getElementById('userName').textContent = profile.name;
                userAvatar.textContent = profile.name.charAt(0).toUpperCase();
            }
        }
        hydrateUserProfile();

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹';

            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Feature tab switching
        featureTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');

                // Update active tab
                featureTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Show corresponding content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });

                // Reset display panel based on tab
                resetDisplayPanel();
                if (tabId === 'analytics') {
                    loadAnalyticsDashboard();
                } else if (tabId === 'chat') {
                    initializeChat();
                }
            });
        });

        function resetDisplayPanel() {
            initialState.classList.remove('hidden');
            loadingState.classList.add('hidden');
            resultsState.classList.remove('active');
            quizState.classList.remove('active');
            chatState.classList.remove('active');
            analyticsState.classList.remove('active');
        }

        function renderQuestionsList(questions) {
            resultsContent.innerHTML = '';

            if (!Array.isArray(questions) || questions.length === 0) {
                const emptyState = document.createElement('p');
                emptyState.textContent = 'No questions generated yet. Try a new topic!';
                resultsContent.appendChild(emptyState);
                return;
            }

            const list = document.createElement('ol');
            questions.forEach(questionObj => {
                if (!questionObj || !questionObj.question) {
                    return;
                }

                const item = document.createElement('li');
                const meta = document.createElement('strong');
                const type = questionObj.type || 'general';
                const difficulty = questionObj.difficulty || 'medium';
                meta.textContent = `(${type}, ${difficulty})`;
                item.appendChild(meta);
                item.appendChild(document.createTextNode(` - ${questionObj.question}`));
                list.appendChild(item);
            });

            resultsContent.appendChild(list);
        }

        function renderRecommendationItems(items) {
            const container = document.getElementById('recommendationsList');
            if (!container) {
                return;
            }

            container.innerHTML = '';
            const list = Array.isArray(items) && items.length > 0
                ? items
                : ['Keep practicing to unlock personalized AI insights.'];

            list.forEach(text => {
                if (typeof text !== 'string') {
                    return;
                }
                const card = document.createElement('div');
                card.style.padding = '0.8rem';
                card.style.background = 'var(--light-bg)';
                card.style.borderRadius = '8px';
                card.style.marginBottom = '0.5rem';
                card.style.borderLeft = '4px solid var(--primary-teal)';
                card.textContent = text;
                container.appendChild(card);
            });
        }

        // Load saved form values
        if (localStorage.getItem('lastTopic')) {
            topicInput.value = localStorage.getItem('lastTopic');
        }
        if (localStorage.getItem('lastJobDescription')) {
            jobDescriptionInput.value = localStorage.getItem('lastJobDescription');
        }
        if (localStorage.getItem('lastInterviewType')) {
            interviewTypeSelect.value = localStorage.getItem('lastInterviewType');
        }
        if (localStorage.getItem('lastCompanyNature')) {
            companyNatureSelect.value = localStorage.getItem('lastCompanyNature');
        }

        // Load history from localStorage
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('questionHistory') || '[]');
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<p style="color: #999; font-size: 0.85rem; text-align: center; padding: 1rem;">No history yet. Generate some questions to get started!</p>';
                return;
            }

            history.slice(0, 5).forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-item-topic">${item.topic}</div>
                    <div class="history-item-date">${new Date(item.date).toLocaleDateString()}</div>
                `;
                historyItem.onclick = () => {
                    topicInput.value = item.topic;
                    if (item.jobDesc) jobDescriptionInput.value = item.jobDesc;
                    if (item.interviewType) interviewTypeSelect.value = item.interviewType;
                    if (item.companyNature) companyNatureSelect.value = item.companyNature;

                    showToast('Form filled with previous topic!', 'info');
                };
                historyList.appendChild(historyItem);
            });
        }

        // Save to history
        function saveToHistory(topic, jobDesc, interviewType, companyNature) {
            const history = JSON.parse(localStorage.getItem('questionHistory') || '[]');

            const filtered = history.filter(item =>
                !(item.topic === topic && item.jobDesc === jobDesc)
            );

            filtered.unshift({
                topic: topic,
                jobDesc: jobDesc,
                interviewType: interviewType,
                companyNature: companyNature,
                date: new Date().toISOString()
            });

            const updated = filtered.slice(0, 10);
            localStorage.setItem('questionHistory', JSON.stringify(updated));
            loadHistory();
        }

        // Save favorite
        saveFavoriteBtn.addEventListener('click', function () {
            if (!currentTopic || currentQuestions.length === 0) {
                showToast('No questions to save', 'error');
                return;
            }

            const favorites = JSON.parse(localStorage.getItem('favoriteQuestions') || '[]');

            const exists = favorites.some(fav => fav.topic === currentTopic && fav.jobDesc === currentJobDesc);
            if (exists) {
                showToast('Already saved to favorites!', 'info');
                return;
            }

            favorites.push({
                topic: currentTopic,
                jobDesc: currentJobDesc,
                interviewType: currentInterviewType,
                companyNature: currentCompanyNature,
                questions: currentQuestions,
                date: new Date().toISOString()
            });

            localStorage.setItem('favoriteQuestions', JSON.stringify(favorites));
            showToast('Saved to favorites! â­', 'success');
        });

        // Download as PDF
        downloadPdfBtn.addEventListener('click', function () {
            if (!currentTopic || currentQuestions.length === 0) {
                showToast('No questions to download', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Title
                doc.setFontSize(20);
                doc.setTextColor(15, 52, 96);
                doc.text('AjiEasy Interview Questions', 20, 20);

                // Topic and details
                doc.setFontSize(12);
                doc.setTextColor(22, 199, 154);
                doc.text(`Topic: ${currentTopic}`, 20, 35);
                doc.text(`Role: ${currentJobDesc}`, 20, 42);
                doc.text(`Interview Type: ${currentInterviewType} | Company: ${currentCompanyNature}`, 20, 49);

                // Questions
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                let yPosition = 60;

                currentQuestions.forEach((questionObj, index) => {
                    const questionText = `${index + 1}. (${questionObj.type}, ${questionObj.difficulty}) ${questionObj.question}`;
                    const lines = doc.splitTextToSize(questionText, 170);

                    // Check if we need a new page
                    if (yPosition + (lines.length * 7) > 280) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.text(lines, 20, yPosition);
                    yPosition += lines.length * 7 + 5;
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Generated by AjiEasy - Your AI Interview Prep Assistant', 20, 285);

                doc.save(`AjiEasy-${currentTopic.replace(/\s+/g, '-')}.pdf`);
                showToast('PDF downloaded successfully! ðŸ“„', 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                showToast('Failed to generate PDF', 'error');
            }
        });

        // Share via email
        shareEmailBtn.addEventListener('click', function () {
            if (!currentTopic || currentQuestions.length === 0) {
                showToast('No questions to share', 'error');
                return;
            }

            let emailBody = `Hi,\n\nHere are the interview questions for "${currentTopic}":\n\n`;
            emailBody += `Role: ${currentJobDesc}\n`;
            emailBody += `Interview Type: ${currentInterviewType}\n`;
            emailBody += `Company Nature: ${currentCompanyNature}\n\n`;
            emailBody += `Questions:\n\n`;

            currentQuestions.forEach((q, index) => {
                emailBody += `${index + 1}. (${q.type}, ${q.difficulty}) ${q.question}\n\n`;
            });

            emailBody += `\nBest regards,\nGenerated by AjiEasy`;

            const subject = encodeURIComponent(`Interview Questions: ${currentTopic}`);
            const body = encodeURIComponent(emailBody);

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
            showToast('Opening email client...', 'info');
        });

        // ==================== LOCAL FALLBACK QUESTION GENERATOR ====================
        function generateLocalQuestions(topic, jobDesc, interviewType, companyNature) {
            const questionTemplates = {
                technical: [
                    `Explain the main concepts of ${topic} to someone non-technical.`,
                    `What are the key advantages of using ${topic} in production?`,
                    `Describe a challenging ${topic} problem you solved and what you learned.`,
                    `How would you optimize a slow ${topic} application?`,
                    `What testing strategies are important for ${topic} projects?`,
                    `How does ${topic} handle scalability and performance?`,
                    `What are the security best practices for ${topic} development?`,
                    `How would you debug a complex issue in a ${topic} system?`
                ],
                behavioral: [
                    `Tell me about a time you had to learn ${topic} quickly for a project.`,
                    `Describe how you would mentor someone new to ${topic}.`,
                    `How do you handle disagreements about ${topic} implementation?`,
                    `Share an example of a successful ${topic} project you led.`,
                    `What's your process for staying updated with ${topic} trends?`,
                    `Describe a time you failed with ${topic} and what you learned.`,
                    `How do you approach code review for ${topic} projects?`,
                    `Tell me about a time you improved ${topic} processes.`
                ],
                situational: [
                    `How would you approach a legacy ${topic} system with no documentation?`,
                    `What would you do if you found a security issue in your ${topic} code?`,
                    `How do you balance ${topic} best practices with tight deadlines?`,
                    `Describe your approach to code review for ${topic} projects.`,
                    `How would you convince stakeholders to adopt a new ${topic} approach?`,
                    `What would you do if your ${topic} implementation wasn't meeting performance goals?`,
                    `How would you handle a production outage in a ${topic} system?`,
                    `Describe how you'd plan a major ${topic} migration.`
                ]
            };

            const questions = [];
            for (let i = 0; i < 8; i++) {
                const type = i % 3 === 0 ? 'technical' : i % 3 === 1 ? 'behavioral' : 'situational';
                const templates = questionTemplates[type];
                const question = templates[i % templates.length];

                questions.push({
                    question: question,
                    type: type,
                    difficulty: 'medium',
                    explanation: `This ${type} question assesses your ${topic} knowledge in ${jobDesc.toLowerCase()} contexts.`
                });
            }

            return questions;
        }

        // ==================== AUTHENTICATED REQUEST FUNCTION ====================
       async function authenticatedRequest(endpoint, options = {}) {
            const token = localStorage.getItem('accessToken'); // âœ… Fixed

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            };

            const config = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            try {
                const response = await fetch(`${API_CONFIG.baseURL}${endpoint}`, config);

                if (response.status === 401) {
                    // Token expired or invalid - clear all auth data
                    console.warn('ðŸ›‘ Token expired or invalid, redirecting to login');
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('user');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userName');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }
        // ==================== QUIZ FUNCTIONALITY ====================

        // Start quiz with real data from free APIs
        function startRealQuiz(quizData) {
            currentQuiz = quizData;
            currentQuestionIndex = 0;
            quizScore = 0;

            // Update UI
            initialState.classList.add('hidden');
            quizState.classList.add('active');
            quizTopicBadge.textContent = quizData.topic;

            displayQuestion(currentQuestionIndex);
        }

        function displayQuestion(index) {
            if (!currentQuiz || index >= currentQuiz.questions.length) {
                showQuizResults();
                return;
            }

            const question = currentQuiz.questions[index];
            const progress = ((index + 1) / currentQuiz.total_questions) * 100;

            quizInterface.innerHTML = `
                <div class="quiz-header">
=======
                <div id="quizInterface" class="hidden fade-in">
>>>>>>> bd3d95b75bcc32ad7687910f1367b950f0d0e77b
                    <div class="quiz-progress">
                        <span id="quizProgressText">Question 1 of 10</span>
                        <div class="progress-bar"><div class="progress-fill" id="quizProgressBar" style="width: 10%"></div></div>
                    </div>

                    <div id="quizQuestionContainer">
                        <!-- Questions injected here -->
                    </div>

                    <div class="quiz-controls">
                        <button id="nextQuestionBtn" class="btn-secondary hidden">Next Question</button>
                        <button id="finishQuizBtn" class="btn-primary hidden">Finish Quiz</button>
                    </div>
                </div>

                <div id="quizResults" class="hidden fade-in">
                    <div class="score-card">
                        <h3>Quiz Complete!</h3>
                        <div class="score-display">
                            <span id="finalScore">0</span>%
                        </div>
                        <p id="scoreMessage">Great job!</p>
                        <button class="btn-primary" onclick="location.reload()">Take Another Quiz</button>
                    </div>
                </div>
            </div>

            <!-- Chat View -->
            <div id="chatView" class="view-section">
                <div class="section-header">
                    <h2>AI Chat Coach</h2>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message">
                            <div class="message-avatar"><i class="fas fa-robot"></i></div>
                            <div class="message-content">
                                Hello! I'm your AI Interview Coach. I can help you practice answers, review your resume, or discuss technical topics. What would you like to work on?
                            </div>
                        </div>
                    </div>

                    <form class="chat-input-area" id="chatForm">
                        <input type="text" id="chatInput" placeholder="Type your message..." required autocomplete="off">
                        <button type="submit" class="btn-send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analyticsView" class="view-section">
                <div class="section-header">
                    <h2>Performance Analytics</h2>
                    <button class="btn-secondary" id="refreshAnalytics"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>

                <div class="analytics-grid">
                    <div class="stat-card">
                        <div class="stat-icon icon-blue"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="statQuestions">0</div>
                        <div class="stat-label">Questions Generated</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon icon-teal"><i class="fas fa-star"></i></div>
                        <div class="stat-value" id="statQuizScore">0%</div>
                        <div class="stat-label">Avg Quiz Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon icon-purple"><i class="fas fa-fire"></i></div>
                <div class="chat-welcome">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h4>Hello! I'm your AI Interview Coach</h4>
                    <p>I can help you with:</p>
                    <ul>
                        <li>Interview preparation tips</li>
                        <li>Career advice</li>
                        <li>Technical explanations</li>
                        <li>Behavioral question practice</li>
                        <li>Resume and portfolio guidance</li>
                    </ul>
                    <p>What would you like to discuss today?</p>
                </div>
            `;

            chatHistory = [];
            document.getElementById('chatInputContainer').style.display = 'none';
            document.getElementById('chatTopicBadge').textContent = 'Ready to help!';
        }

        // Display Chat Message
        function displayChatMessage(userMessage, aiResponse, topic) {
            const chatInterface = document.getElementById('chatInterface');
            const messageId = 'msg-' + Date.now();

            const messageHTML = `
                <div class="chat-message user-message" id="${messageId}">
                    <div class="message-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${userMessage}</div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
                <div class="chat-message ai-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${aiResponse}</div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;

            chatInterface.innerHTML += messageHTML;
            chatInterface.scrollTop = chatInterface.scrollHeight;

            // Update chat topic badge
            document.getElementById('chatTopicBadge').textContent = topic;

            // Show continue chat input
            document.getElementById('chatInputContainer').style.display = 'block';

            // Save to chat history
            chatHistory.push({
                user: userMessage,
                ai: aiResponse,
                timestamp: new Date().toISOString(),
                topic: topic
            });
        }

        // Chat event handlers
        sendChatBtn.addEventListener('click', async function () {
            const topic = document.getElementById('chatTopic').value.trim();
            const message = document.getElementById('chatMessage').value.trim();

            if (!topic || !message) {
                showToast('Please enter both topic and message', 'error');
                return;
            }

            // Show loading state
            initialState.classList.add('hidden');
            chatState.classList.add('active');
            this.disabled = true;
            loadingMessage.textContent = 'AI is thinking...';
            loadingState.classList.remove('hidden');

            try {
                const response = await authenticatedRequest('/chat/', {
                    method: 'POST',
                    body: JSON.stringify({
                        topic: topic,
                        message: message
                    })
                });

                loadingState.classList.add('hidden');

                if (response && response.response) {
                    displayChatMessage(message, response.response, topic);

                    // Clear input
                    document.getElementById('chatMessage').value = '';
                    showToast('AI response received!', 'success');
                } else {
                    throw new Error('No response from AI');
                }

            } catch (error) {
                loadingState.classList.add('hidden');
                showToast('Failed to get AI response', 'error');
                console.error('Chat error:', error);
            } finally {
                this.disabled = false;
            }
        });

        continueChatBtn.addEventListener('click', async function () {
            const message = document.getElementById('continueChat').value.trim();
            const topic = document.getElementById('chatTopicBadge').textContent;

            if (!message) {
                showToast('Please enter a message', 'error');
                return;
            }

            this.disabled = true;
            const continueChatInput = document.getElementById('continueChat');
            continueChatInput.disabled = true;

            try {
                const response = await authenticatedRequest('/chat/', {
                    method: 'POST',
                    body: JSON.stringify({
                        topic: topic,
                        message: message
                    })
                });

                if (response && response.response) {
                    displayChatMessage(message, response.response, topic);
                    continueChatInput.value = '';
                    showToast('Response received!', 'success');
                } else {
                    throw new Error('No response from AI');
                }
            } catch (error) {
                showToast('Failed to send message', 'error');
            } finally {
                this.disabled = false;
                continueChatInput.disabled = false;
            }
        });

        clearChatBtn.addEventListener('click', function () {
            initializeChat();
            showToast('Chat cleared', 'info');
        });

        saveChatBtn.addEventListener('click', function () {
            if (chatHistory.length === 0) {
                showToast('No chat history to save', 'error');
                return;
            }

            const chatContent = JSON.stringify(chatHistory, null, 2);
            const blob = new Blob([chatContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ajieasy-chat-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Chat saved as JSON file!', 'success');
        });

        // ==================== ANALYTICS FUNCTIONALITY ====================

        // Enhanced analytics with real data
        async function loadAnalyticsDashboard() {
            try {
                const analyticsData = await authenticatedRequest('/analytics/?period=30');
                renderServerAnalytics(analyticsData);
            } catch (error) {
                console.warn('Analytics fetch failed, using local insights:', error);
                renderLocalAnalytics();
            }
        }

        function renderServerAnalytics(data) {
            const performanceTrend = data.performance_trend || [];
            const topicMastery = data.topic_mastery || {};
            const averageScore = data.average_score || 0;
            const totalQuestions = data.total_questions_attempted || 0;

            analyticsPeriodBadge.textContent = data.period || 'last_30_days';

            analyticsDashboard.innerHTML = `
                <div class="analytics-header">
                    <h4>Your Learning Progress</h4>
                    <div class="summary-stats" style="display: flex; gap: 1rem; font-size: 0.9rem;">
                        <div style="background: var(--success); color: white; padding: 0.3rem 0.8rem; border-radius: 10px;">
                            Avg Score: ${Math.round(averageScore)}%
                        </div>
                        <div style="background: var(--primary-blue); color: white; padding: 0.3rem 0.8rem; border-radius: 10px;">
                            Questions: ${totalQuestions}
                        </div>
                        <div style="background: var(--primary-teal); color: white; padding: 0.3rem 0.8rem; border-radius: 10px;">
                            Insights: Powered by Gemini
                        </div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <div class="chart-title">Performance Trend</div>
                        <canvas id="performanceChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <div class="chart-title">Topic Mastery</div>
                        <canvas id="topicsChart" width="400" height="200"></canvas>
                    </div>
                </div>
                <div class="recommendations-section" style="margin-top: 1.5rem;">
                    <h5 style="color: var(--primary-blue); margin-bottom: 1rem;">
                        <i class="fas fa-bullseye"></i> AI Recommendations
                    </h5>
                    <div class="recommendations-list" id="recommendationsList"></div>
                </div>
            `;

            renderRecommendationItems(data.recommendations);
            initializeCharts(performanceTrend, topicMastery);
        }

        function renderLocalAnalytics() {
            const savedQuizzes = JSON.parse(localStorage.getItem('savedQuizResults') || '[]');
            const questionHistory = JSON.parse(localStorage.getItem('questionHistory') || '[]');

            const totalQuizzes = savedQuizzes.length;
            const averageScore = totalQuizzes > 0
                ? savedQuizzes.reduce((sum, quiz) => sum + quiz.percentage, 0) / totalQuizzes
                : 75;

            const topicPerformance = {};
            savedQuizzes.forEach(quiz => {
                if (!topicPerformance[quiz.topic]) {
                    topicPerformance[quiz.topic] = { total: 0, count: 0 };
                }
                topicPerformance[quiz.topic].total += quiz.percentage;
                topicPerformance[quiz.topic].count += 1;
            });

            const topicMastery = {};
            Object.keys(topicPerformance).forEach(topic => {
                topicMastery[topic] = Math.round(topicPerformance[topic].total / topicPerformance[topic].count);
            });

            const performanceTrend = generatePerformanceTrend(savedQuizzes);

            analyticsPeriodBadge.textContent = 'local history';

            analyticsDashboard.innerHTML = `
                <div class="analytics-header">
                    <h4>Your Learning Progress</h4>
                    <div class="summary-stats" style="display: flex; gap: 1rem; font-size: 0.9rem;">
                        <div style="background: var(--success); color: white; padding: 0.3rem 0.8rem; border-radius: 10px;">
                            Avg Score: ${Math.round(averageScore)}%
                        </div>
                        <div style="background: var(--primary-blue); color: white; padding: 0.3rem 0.8rem; border-radius: 10px;">
                            Quizzes: ${totalQuizzes}
                        </div>
                        <div style="background: var(--primary-teal); color: white; padding: 0.3rem 0.8rem; border-radius: 10px;">
                            Questions: ${questionHistory.length}
                        </div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <div class="chart-title">Performance Trend</div>
                        <canvas id="performanceChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <div class="chart-title">Topic Mastery</div>
                        <canvas id="topicsChart" width="400" height="200"></canvas>
                    </div>
                </div>
                <div class="recommendations-section" style="margin-top: 1.5rem;">
                    <h5 style="color: var(--primary-blue); margin-bottom: 1rem;">
                        <i class="fas fa-bullseye"></i> Practice Suggestions
                    </h5>
                    <div class="recommendations-list" id="recommendationsList"></div>
                </div>
            `;

            renderRecommendationItems(generateRecommendations(topicMastery, averageScore));
            initializeCharts(performanceTrend, topicMastery);
        }

        function generatePerformanceTrend(quizzes) {
            // Generate performance trend for last 7 days
            const trend = [];
            const today = new Date();

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                const dayQuizzes = quizzes.filter(q => q.date.split('T')[0] === dateStr);
                const dayAverage = dayQuizzes.length > 0
                    ? dayQuizzes.reduce((sum, q) => sum + q.percentage, 0) / dayQuizzes.length
                    : (trend[trend.length - 1] || 70) + (Math.random() * 10 - 5); // Smooth random trend

                trend.push(Math.max(50, Math.min(100, Math.round(dayAverage))));
            }

            return trend;
        }

        function generateRecommendations(topicMastery, averageScore) {
            const recommendations = [];

            // Find weakest topic
            const topics = Object.keys(topicMastery);
            if (topics.length > 0) {
                const weakestTopic = topics.reduce((weakest, topic) =>
                    topicMastery[topic] < topicMastery[weakest] ? topic : weakest
                );

                if (topicMastery[weakestTopic] < 70) {
                    recommendations.push(`Focus on improving your ${weakestTopic} skills - current score: ${topicMastery[weakestTopic]}%`);
                }
            }

            // General recommendations based on average score
            if (averageScore < 70) {
                recommendations.push("Practice more consistently to improve your overall performance");
            } else if (averageScore > 85) {
                recommendations.push("Excellent work! Consider challenging yourself with more difficult topics");
            }

            if (topics.length < 3) {
                recommendations.push("Try exploring more diverse topics to build comprehensive interview skills");
            }

            if (recommendations.length === 0) {
                recommendations.push("Keep up the good work! Consider setting specific goals for each study session.");
            }

            return recommendations.slice(0, 3);
        }

        function initializeCharts(performanceTrend, topicMastery) {
            // Performance Trend Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: ['6d ago', '5d ago', '4d ago', '3d ago', '2d ago', 'Yesterday', 'Today'],
                    datasets: [{
                        label: 'Daily Score (%)',
                        data: performanceTrend,
                        borderColor: 'rgb(22, 199, 154)',
                        backgroundColor: 'rgba(22, 199, 154, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            min: 50,
                            max: 100
                        }
                    }
                }
            });

            // Topics Chart
            const topicsCtx = document.getElementById('topicsChart').getContext('2d');
            const topics = Object.keys(topicMastery);
            const scores = Object.values(topicMastery);

            // If no topic data, show sample data
            const chartLabels = topics.length > 0 ? topics : ['Python', 'JavaScript', 'System Design', 'Behavioral'];
            const chartData = topics.length > 0 ? scores : [85, 78, 65, 88];

            new Chart(topicsCtx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Score (%)',
                        data: chartData,
                        backgroundColor: [
                            'rgba(22, 199, 154, 0.8)',
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        // Load history on page load
        loadHistory();

        // ==================== MAIN QUESTION GENERATION ====================
        // Handle questions form submission with improved error handling
        topicForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            const topic = topicInput.value.trim();
            const jobDesc = jobDescriptionInput.value.trim();
            const interviewType = interviewTypeSelect.value;
            const companyNature = companyNatureSelect.value;

            // Validation
            if (!topic) {
                showToast('Please enter a topic', 'error');
                topicInput.focus();
                return;
            }
            if (!jobDesc) {
                showToast('Job Description is required', 'error');
                jobDescriptionInput.focus();
                return;
            }
            if (!interviewType) {
                showToast('Please select the nature of the interview', 'error');
                interviewTypeSelect.focus();
                return;
            }
            if (!companyNature) {
                showToast('Please select the nature of the company', 'error');
                companyNatureSelect.focus();
                return;
            }

            // Save form values
            localStorage.setItem('lastTopic', topic);
            localStorage.setItem('lastJobDescription', jobDesc);
            localStorage.setItem('lastInterviewType', interviewType);
            localStorage.setItem('lastCompanyNature', companyNature);

            // Show loading state
            initialState.classList.add('hidden');
            resultsState.classList.remove('active');
            quizState.classList.remove('active');
            chatState.classList.remove('active');
            analyticsState.classList.remove('active');
            loadingState.classList.remove('hidden');
            loadingMessage.textContent = 'Generating your personalized questions...';
            generateBtn.disabled = true;
            topicInput.disabled = true;
            jobDescriptionInput.disabled = true;
            interviewTypeSelect.disabled = true;
            companyNatureSelect.disabled = true;

            // Show progress bar
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';

            // Animate progress bar
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 10;
                    progressBar.style.width = progress + '%';
                }
            }, 500);

            try {
                // Try to get questions from backend
                const response = await authenticatedRequest('/generate-questions/', {
                    method: 'POST',
                    body: JSON.stringify({
                        topic: topic,
                        job_description: jobDesc,
                        interview_type: interviewType,
                        company_nature: companyNature
                    })
                });

                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                // IMPROVED ERROR HANDLING - Multiple response formats
                let questions = [];

                if (response && Array.isArray(response)) {
                    // Direct array response
                    questions = response;
                } else if (response && response.questions && Array.isArray(response.questions)) {
                    // Nested questions array
                    questions = response.questions;
                } else if (response && response.error) {
                    throw new Error(response.error);
                } else {
                    // If no valid response, use local fallback
                    console.log('Using local fallback generator');
                    questions = generateLocalQuestions(topic, jobDesc, interviewType, companyNature);
                    showToast('Using enhanced local question generator!', 'info');
                }

                // Success case
                loadingState.classList.add('hidden');
                currentQuestions = questions;
                currentTopic = topic;
                currentJobDesc = jobDesc;
                currentInterviewType = interviewType;
                currentCompanyNature = companyNature;

                topicBadge.textContent = topic;

                renderQuestionsList(questions);
                resultsState.classList.add('active');

                // Re-enable form
                generateBtn.disabled = false;
                topicInput.disabled = false;
                jobDescriptionInput.disabled = false;
                interviewTypeSelect.disabled = false;
                companyNatureSelect.disabled = false;

                // Save to history
                saveToHistory(topic, jobDesc, interviewType, companyNature);

                // Show success toast
                showToast(`Generated ${questions.length} questions successfully! ðŸŽ‰`, 'success');

                // Scroll to results
                displayPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                clearInterval(progressInterval);
                progressBar.style.width = '0%';

                console.error('API Error, using local fallback:', error);

                // Use local fallback on error
                const localQuestions = generateLocalQuestions(topic, jobDesc, interviewType, companyNature);
                currentQuestions = localQuestions;
                currentTopic = topic;
                currentJobDesc = jobDesc;
                currentInterviewType = interviewType;
                currentCompanyNature = companyNature;

                renderQuestionsList(localQuestions);
                loadingState.classList.add('hidden');
                resultsState.classList.add('active');
                topicBadge.textContent = topic;

                // Re-enable form
                generateBtn.disabled = false;
                topicInput.disabled = false;
                jobDescriptionInput.disabled = false;
                interviewTypeSelect.disabled = false;
                companyNatureSelect.disabled = false;

                saveToHistory(topic, jobDesc, interviewType, companyNature);
                showToast(`Generated ${localQuestions.length} questions using local generator!`, 'info');

            } finally {
                // Hide progress bar after a short delay
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 1500);
            }
        });

        // Handle quiz form submission
        quizForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            const topic = document.getElementById('quizTopic').value.trim();
            const difficulty = document.getElementById('quizDifficulty').value;
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const focusAreas = document.getElementById('quizFocus').value.trim();

            if (!topic) {
                showToast('Please enter a quiz topic', 'error');
                return;
            }

            // Show loading state
            loadingMessage.textContent = 'Creating your quiz with AI...';
            initialState.classList.add('hidden');
            loadingState.classList.remove('hidden');
            generateQuizBtn.disabled = true;

            try {
                // Use free APIs for quiz generation
                const response = await authenticatedRequest('/generate-quiz/', {
                    method: 'POST',
                    body: JSON.stringify({
                        topic: topic,
                        difficulty: difficulty,
                        question_count: questionCount,
                        focus_areas: focusAreas
                    })
                });

                loadingState.classList.add('hidden');

                if (response && response.questions && response.questions.length > 0) {
                    startRealQuiz(response);
                    showToast(`Quiz generated successfully! ðŸš€ (via ${response.source || 'AI'})`, 'success');

                    // Save to quiz history
                    saveToQuizHistory(topic, difficulty, questionCount, response.source);
                } else {
                    throw new Error('No questions generated');
                }
            } catch (error) {
                loadingState.classList.add('hidden');
                initialState.classList.remove('hidden');
                showToast('Failed to generate quiz. Please try again.', 'error');
                console.error('Quiz generation error:', error);
            } finally {
                generateQuizBtn.disabled = false;
            }
        });

        function saveToQuizHistory(topic, difficulty, questionCount, source) {
            const history = JSON.parse(localStorage.getItem('quizHistory') || '[]');

            history.unshift({
                topic: topic,
                difficulty: difficulty,
                questionCount: questionCount,
                source: source,
                date: new Date().toISOString()
            });

            const updated = history.slice(0, 10);
            localStorage.setItem('quizHistory', JSON.stringify(updated));
        }

        // Handle analytics refresh
        refreshAnalyticsBtn.addEventListener('click', function () {
            const period = document.getElementById('analyticsPeriod').value;
            analyticsPeriodBadge.textContent = `Last ${period} Days`;
            loadAnalyticsDashboard();
            showToast('Analytics updated!', 'success');
        });

        // Handle quiz restart
        restartQuizBtn.addEventListener('click', function () {
            if (currentQuiz) {
                startRealQuiz(currentQuiz);
            }
        });

        // Handle analytics export
        exportAnalyticsBtn.addEventListener('click', function () {
            showToast('Export feature coming soon!', 'info');
        });

        // Add some interactive animations
        document.addEventListener('DOMContentLoaded', function () {
            // Add floating animation to initial state icon
            const icon = document.querySelector('.initial-state .icon');
            if (icon) {
                icon.style.animation = 'float 3s ease-in-out infinite';
            }

            // Add click animation to buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function () {
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });

            // Initialize chat if on chat tab
            if (document.querySelector('.feature-tab.active').getAttribute('data-tab') === 'chat') {
                initializeChat();
            }
        });

        // Initialize the app
        loadHistory();
    </script>
=======
                <div class="analytics-charts">
                    <div class="chart-container">
                        <h3>Topic Mastery</h3>
                        <div id="topicMasteryChart" class="chart-placeholder">
                            <!-- Simple CSS Bar Chart injected here -->
                            <p class="text-muted">Complete quizzes to see data</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="auth.js"></script>
    <script src="js/app.js"></script>
>>>>>>> bd3d95b75bcc32ad7687910f1367b950f0d0e77b
</body>
</html>