<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AjiEasy - AI Interview Preparation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-blue: #0f3460;
            --primary-teal: #16c79a;
            --accent-purple: #667eea;
            --accent-pink: #764ba2;
            --dark-blue: #1a1a2e;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --text-dark: #333333;
            --text-light: #666666;
            --border-light: #e0e0e0;
            --success: #16c79a;
            --error: #dc3545;
            --warning: #ffc107;
            --shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-hover);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid var(--success);
            backdrop-filter: blur(10px);
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        .toast.info {
            border-left-color: var(--primary-blue);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-message {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
            transition: color 0.3s ease;
        }

        .toast-close:hover {
            color: var(--text-dark);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Navbar */
        .navbar {
            background: rgba(15, 52, 96, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .brand {
            color: var(--white);
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .brand i {
            color: var(--primary-teal);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-info {
            color: var(--white);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-teal);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--white);
        }

        .btn-logout {
            padding: 0.7rem 1.5rem;
            border: 2px solid var(--white);
            background-color: transparent;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--white);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-logout:hover {
            background-color: var(--white);
            color: var(--primary-blue);
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        .app-container {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 2rem;
            min-height: 600px;
        }

        /* Control Panel */
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-panel h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-panel h2 i {
            color: var(--primary-teal);
        }

        /* Feature Tabs */
        .feature-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-light);
        }

        .feature-tab {
            padding: 0.8rem 1.2rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feature-tab.active {
            color: var(--primary-teal);
            border-bottom-color: var(--primary-teal);
        }

        .feature-tab:hover {
            color: var(--primary-blue);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.2rem;
        }

        .input-group label {
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .input-group label span.required {
            color: var(--error);
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: rgba(248, 249, 250, 0.8);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-teal);
            background-color: var(--white);
            box-shadow: 0 0 0 3px rgba(22, 199, 154, 0.1);
            transform: translateY(-2px);
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: var(--border-light);
            border-radius: 12px;
            height: 8px;
            overflow: hidden;
            display: none;
            margin: 1rem 0;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary-teal), #13a77e);
            transition: width 0.3s ease;
            border-radius: 12px;
        }

        .btn-generate {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, var(--primary-teal), #13a77e);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(22, 199, 154, 0.3);
        }

        .btn-generate:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(22, 199, 154, 0.4);
        }

        .btn-generate:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Quiz Options */
        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .option-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-blue);
        }

        .option-group select {
            padding: 0.7rem;
            font-size: 0.9rem;
        }

        /* Chat Interface Styles */
        .chat-interface {
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--light-bg);
            border-radius: 15px;
            margin-bottom: 1rem;
        }

        .chat-welcome {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .welcome-icon {
            font-size: 3rem;
            color: var(--primary-teal);
            margin-bottom: 1rem;
        }

        .chat-message {
            display: flex;
            margin-bottom: 1.5rem;
            animation: slideIn 0.3s ease-out;
        }

        .chat-message.user-message {
            justify-content: flex-end;
        }

        .chat-message.user-message .message-content {
            background: var(--primary-blue);
            color: white;
        }

        .chat-message.ai-message .message-content {
            background: white;
            border: 2px solid var(--border-light);
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1rem;
            background: var(--primary-teal);
            color: white;
            flex-shrink: 0;
        }

        .chat-message.user-message .message-avatar {
            background: var(--primary-blue);
            order: 2;
        }

        .message-content {
            max-width: 70%;
            padding: 1rem 1.5rem;
            border-radius: 18px;
            box-shadow: var(--shadow);
        }

        .message-text {
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            text-align: right;
        }

        .chat-input-container {
            background: white;
            padding: 1rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        /* History Section */
        .history-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border-light);
        }

        .history-section h3 {
            font-size: 1.1rem;
            color: var(--primary-blue);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 180px;
            overflow-y: auto;
        }

        .history-item {
            padding: 1rem;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .history-item:hover {
            background: var(--white);
            border-color: var(--primary-teal);
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .history-item-topic {
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }

        .history-item-date {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Info Box */
        .info-box {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-teal));
            border-radius: 16px;
            color: var(--white);
            box-shadow: var(--shadow);
        }

        .info-box h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-box p {
            font-size: 0.85rem;
            line-height: 1.6;
            opacity: 0.95;
        }

        /* Display Panel */
        .display-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow);
            overflow-y: auto;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            max-height: calc(100vh - 200px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Initial State */
        .initial-state {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            padding: 2rem;
            width: 100%;
            height: 100%;
        }

        .initial-state .icon {
            font-size: 6rem;
            color: var(--primary-teal);
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .initial-state h3 {
            font-size: 2.2rem;
            color: var(--primary-blue);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .initial-state p {
            font-size: 1.1rem;
            color: var(--text-light);
            max-width: 400px;
            line-height: 1.8;
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            padding: 2rem;
            width: 100%;
            height: 100%;
        }

        .spinner {
            width: 70px;
            height: 70px;
            border: 6px solid rgba(22, 199, 154, 0.2);
            border-top: 6px solid var(--primary-teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-state p {
            font-size: 1.2rem;
            color: var(--primary-blue);
            font-weight: 600;
            text-align: center;
        }

        /* Results State */
        .results-state {
            width: 100%;
            display: none;
        }

        .results-state.active {
            display: block;
        }

        .results-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-header-left h3 {
            font-size: 1.8rem;
            color: var(--primary-blue);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .results-header .topic-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-teal), #13a77e);
            color: var(--white);
            padding: 0.5rem 1.2rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(22, 199, 154, 0.3);
        }

        .results-actions {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 0.7rem 1.4rem;
            border: 2px solid var(--primary-blue);
            background: var(--white);
            color: var(--primary-blue);
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-action:hover {
            background: var(--primary-blue);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-action.favorite {
            border-color: var(--primary-teal);
            color: var(--primary-teal);
        }

        .btn-action.favorite:hover {
            background: var(--primary-teal);
            color: var(--white);
        }

        /* Analytics Dashboard */
        .analytics-dashboard {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--white);
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .analytics-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .analytics-header h4 {
            font-size: 1.3rem;
            color: var(--primary-blue);
            font-weight: 700;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .chart-wrapper {
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 10px;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        /* Quiz Interface */
        .quiz-interface {
            margin-bottom: 2rem;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .quiz-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .quiz-question {
            background: var(--white);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .quiz-option {
            padding: 1rem 1.5rem;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .quiz-option:hover {
            border-color: var(--primary-teal);
            transform: translateX(5px);
        }

        .quiz-option.selected {
            border-color: var(--primary-teal);
            background: rgba(22, 199, 154, 0.1);
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
        }

        .hint-section {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 10px;
            border-left: 4px solid var(--warning);
        }

        .hint-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .hint-header h5 {
            color: var(--warning);
            font-weight: 600;
        }

        .hint-content {
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        /* Results Content */
        .results-content {
            line-height: 1.8;
            width: 100%;
        }

        .results-content ol {
            counter-reset: item;
            list-style: none;
            padding-left: 0;
            width: 100%;
        }

        .results-content ol li {
            counter-increment: item;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            padding-left: 4rem;
            position: relative;
            font-size: 1.05rem;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 12px;
            border-left: 4px solid var(--primary-teal);
            transition: all 0.3s ease;
            width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .results-content ol li:hover {
            background: var(--white);
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .results-content ol li::before {
            content: counter(item);
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, var(--primary-teal), #13a77e);
            color: var(--white);
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(22, 199, 154, 0.3);
        }

        .results-content strong {
            color: var(--primary-blue);
            font-weight: 600;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Footer */
        .footer {
            background: rgba(15, 52, 96, 0.95);
            backdrop-filter: blur(10px);
            color: var(--white);
            padding: 1.5rem 2rem;
            text-align: center;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .footer-links {
            display: flex;
            gap: 2rem;
        }

        .footer-links a {
            color: var(--white);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--primary-teal);
        }

        /* Enhanced Desktop Optimizations */
        @media (min-width: 1024px) {
            .app-container {
                grid-template-columns: 450px 1fr;
                gap: 2.5rem;
            }

            .display-panel {
                padding: 2.5rem;
            }

            .results-header {
                align-items: flex-start;
            }

            .results-actions {
                justify-content: flex-end;
                flex-wrap: nowrap;
            }

            .btn-action {
                min-width: 120px;
            }
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 992px) {
            .app-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .control-panel,
            .display-panel {
                max-height: none;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .results-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .btn-action {
                flex: 1;
                min-width: 140px;
                justify-content: center;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .brand {
                font-size: 1.5rem;
            }

            .main-content {
                padding: 1rem;
            }

            .control-panel,
            .display-panel {
                padding: 1.5rem;
                border-radius: 16px;
            }

            .quiz-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .results-content ol li {
                padding: 1rem;
                padding-left: 3rem;
                font-size: 0.95rem;
            }

            .results-content ol li::before {
                width: 1.8rem;
                height: 1.8rem;
                font-size: 0.85rem;
                left: 0.8rem;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-teal);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #13a77e;
        }
    </style>
</head>

<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html" class="brand">
            <i class="fas fa-rocket"></i>
            AjiEasy
        </a>
        <div class="nav-right">
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">JS</div>
                <span id="userName">Loading...</span>
            </div>
            <button class="btn-logout" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Log Out
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="app-container">
            <!-- Left Column - Control Panel -->
            <div class="control-panel">
                <h2>
                    <i class="fas fa-brain"></i>
                    AI Interview Assistant
                </h2>

                <!-- Feature Tabs -->
                <div class="feature-tabs">
                    <button class="feature-tab active" data-tab="questions">
                        <i class="fas fa-question-circle"></i>
                        Questions
                    </button>
                    <button class="feature-tab" data-tab="quiz">
                        <i class="fas fa-puzzle-piece"></i>
                        Quiz
                    </button>
                    <button class="feature-tab" data-tab="chat">
                        <i class="fas fa-comments"></i>
                        AI Chat
                    </button>
                    <button class="feature-tab" data-tab="analytics">
                        <i class="fas fa-chart-bar"></i>
                        Analytics
                    </button>
                </div>

                <!-- Questions Tab -->
                <div class="tab-content active" id="questions-tab">
                    <form id="topicForm">
                        <div class="input-group">
                            <label for="topic">
                                <i class="fas fa-tag"></i>
                                Interview Topic
                                <span class="required">*</span>
                            </label>
                            <input type="text" id="topic" name="topic"
                                placeholder="Enter a topic (e.g., Python, Project Management)" required
                                list="topicSuggestions">
                            <datalist id="topicSuggestions">
                                <option value="Python Programming">
                                <option value="JavaScript Basics">
                                <option value="React Development">
                                <option value="Project Management">
                                <option value="Data Structures">
                                <option value="System Design">
                                <option value="Behavioral Questions">
                                <option value="Database Design">
                            </datalist>
                        </div>

                        <div class="input-group">
                            <label for="jobDescription">
                                <i class="fas fa-briefcase"></i>
                                Describe the Job Role
                                <span class="required">*</span>
                            </label>
                            <input type="text" id="jobDescription" name="jobDescription"
                                placeholder="E.g., Software Engineer responsible for backend APIs" required>
                        </div>

                        <div class="input-group">
                            <label for="interviewType">
                                <i class="fas fa-users"></i>
                                Nature of Interview
                            </label>
                            <select id="interviewType" name="interviewType" required>
                                <option value="" disabled selected>Select interview type</option>
                                <option value="Technical">Technical</option>
                                <option value="HR">HR</option>
                                <option value="Managerial">Managerial</option>
                                <option value="Group">Group</option>
                                <option value="Case Study">Case Study</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="companyNature">
                                <i class="fas fa-building"></i>
                                Nature of Company
                            </label>
                            <select id="companyNature" name="companyNature" required>
                                <option value="" disabled selected>Select company nature</option>
                                <option value="Startup">Startup</option>
                                <option value="Small Business">Small Business</option>
                                <option value="Corporation">Corporation</option>
                                <option value="Non-Profit">Non-Profit</option>
                                <option value="Government">Government</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="progress-container" id="progressContainer">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>

                        <button type="submit" class="btn-generate" id="generateBtn">
                            <i class="fas fa-magic"></i>
                            Generate Questions
                        </button>
                    </form>
                </div>

                <!-- Quiz Tab -->
                <div class="tab-content" id="quiz-tab">
                    <form id="quizForm">
                        <div class="input-group">
                            <label for="quizTopic">
                                <i class="fas fa-tag"></i>
                                Quiz Topic
                                <span class="required">*</span>
                            </label>
                            <input type="text" id="quizTopic" name="quizTopic" placeholder="Enter a topic for the quiz"
                                required>
                        </div>

                        <div class="quiz-options">
                            <div class="option-group">
                                <label for="quizDifficulty">Difficulty</label>
                                <select id="quizDifficulty" name="quizDifficulty">
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label for="questionCount">Questions</label>
                                <select id="questionCount" name="questionCount">
                                    <option value="5">5 Questions</option>
                                    <option value="10" selected>10 Questions</option>
                                    <option value="15">15 Questions</option>
                                </select>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="quizFocus">
                                <i class="fas fa-bullseye"></i>
                                Focus Areas
                            </label>
                            <textarea id="quizFocus" name="quizFocus"
                                placeholder="Specific areas you want to focus on (optional)"></textarea>
                        </div>

                        <button type="submit" class="btn-generate" id="generateQuizBtn">
                            <i class="fas fa-play-circle"></i>
                            Start Quiz
                        </button>
                    </form>
                </div>

                <!-- Chat Tab -->
                <div class="tab-content" id="chat-tab">
                    <div class="input-group">
                        <label for="chatTopic">
                            <i class="fas fa-tag"></i>
                            Chat Topic
                        </label>
                        <input type="text" id="chatTopic" name="chatTopic"
                            placeholder="What do you want to discuss? (e.g., Interview tips, Career advice)">
                    </div>

                    <div class="input-group">
                        <label for="chatMessage">
                            <i class="fas fa-message"></i>
                            Your Message
                        </label>
                        <textarea id="chatMessage" name="chatMessage"
                            placeholder="Ask me anything about interviews, careers, or technical topics..."
                            rows="4"></textarea>
                    </div>

                    <button class="btn-generate" id="sendChatBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Message
                    </button>

                    <div class="info-box" style="margin-top: 1rem;">
                        <h3><i class="fas fa-robot"></i> AI Assistant</h3>
                        <p>Get instant help with interview preparation, career advice, and technical explanations from
                            our AI assistant.</p>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-content" id="analytics-tab">
                    <div class="info-box">
                        <h3>
                            <i class="fas fa-chart-line"></i>
                            Performance Insights
                        </h3>
                        <p>Track your progress, identify strengths and weaknesses, and get personalized recommendations
                            for improvement.</p>
                    </div>

                    <div class="input-group">
                        <label for="analyticsPeriod">
                            <i class="fas fa-calendar"></i>
                            Time Period
                        </label>
                        <select id="analyticsPeriod" name="analyticsPeriod">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>

                    <button class="btn-generate" id="refreshAnalyticsBtn">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Analytics
                    </button>
                </div>

                <!-- History Section -->
                <div class="history-section" id="historySection">
                    <h3>
                        <i class="fas fa-history"></i>
                        Recent Activities
                    </h3>
                    <div class="history-list" id="historyList">
                        <!-- History items will be added here -->
                    </div>
                </div>

                <div class="info-box">
                    <h3>
                        <i class="fas fa-lightbulb"></i>
                        AI Pro Tips
                    </h3>
                    <p>Use the quiz feature to test your knowledge and get instant feedback. The analytics dashboard
                        helps you track your improvement over time!</p>
                </div>
            </div>

            <!-- Right Column - Display Panel -->
            <div class="display-panel" id="displayPanel">
                <!-- Initial State -->
                <div class="initial-state" id="initialState">
                    <div class="icon">🎯</div>
                    <h3>Ready to Ace Your Interview?</h3>
                    <p>Choose a feature from the left panel to get started with AI-powered interview preparation!</p>
                </div>

                <!-- Loading State -->
                <div class="loading-state hidden" id="loadingState">
                    <div class="spinner"></div>
                    <p id="loadingMessage">Generating your personalized questions...</p>
                </div>

                <!-- Questions Results State -->
                <div class="results-state" id="resultsState">
                    <div class="results-header">
                        <div class="results-header-left">
                            <h3>Interview Questions</h3>
                            <span class="topic-badge" id="topicBadge"></span>
                        </div>
                        <div class="results-actions">
                            <button class="btn-action favorite" id="saveFavoriteBtn" title="Save to favorites">
                                <i class="fas fa-star"></i>
                                Save
                            </button>
                            <button class="btn-action" id="downloadPdfBtn" title="Download as PDF">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                            <button class="btn-action" id="shareEmailBtn" title="Share via email">
                                <i class="fas fa-envelope"></i>
                                Email
                            </button>
                        </div>
                    </div>
                    <div class="results-content" id="resultsContent"></div>
                </div>

                <!-- Quiz Results State -->
                <div class="results-state" id="quizState">
                    <div class="results-header">
                        <div class="results-header-left">
                            <h3>Interactive Quiz</h3>
                            <span class="topic-badge" id="quizTopicBadge"></span>
                        </div>
                        <div class="results-actions">
                            <button class="btn-action" id="restartQuizBtn">
                                <i class="fas fa-redo"></i>
                                Restart
                            </button>
                        </div>
                    </div>
                    <div class="quiz-interface" id="quizInterface">
                        <!-- Quiz content will be loaded here -->
                    </div>
                </div>

                <!-- Chat State -->
                <div class="results-state" id="chatState">
                    <div class="results-header">
                        <div class="results-header-left">
                            <h3>AI Chat Assistant</h3>
                            <span class="topic-badge" id="chatTopicBadge">Ready to help!</span>
                        </div>
                        <div class="results-actions">
                            <button class="btn-action" id="clearChatBtn">
                                <i class="fas fa-broom"></i>
                                Clear Chat
                            </button>
                            <button class="btn-action favorite" id="saveChatBtn">
                                <i class="fas fa-save"></i>
                                Save Chat
                            </button>
                        </div>
                    </div>
                    <div class="chat-interface" id="chatInterface">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="chat-input-container" style="margin-top: 1rem; display: none;" id="chatInputContainer">
                        <div class="input-group">
                            <textarea id="continueChat" placeholder="Type your follow-up message..."
                                rows="2"></textarea>
                        </div>
                        <button class="btn-generate" id="continueChatBtn">
                            <i class="fas fa-paper-plane"></i>
                            Send
                        </button>
                    </div>
                </div>

                <!-- Analytics State -->
                <div class="results-state" id="analyticsState">
                    <div class="results-header">
                        <div class="results-header-left">
                            <h3>Performance Analytics</h3>
                            <span class="topic-badge" id="analyticsPeriodBadge">Last 30 Days</span>
                        </div>
                        <div class="results-actions">
                            <button class="btn-action" id="exportAnalyticsBtn">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="analytics-dashboard" id="analyticsDashboard">
                        <!-- Analytics charts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div>&copy; 2025 AjiEasy - AI Interview Preparation Platform</div>
            <div class="footer-links">
                <a href="#"><i class="fas fa-shield-alt"></i> Privacy Policy</a>
                <a href="#"><i class="fas fa-file-contract"></i> Terms of Service</a>
            </div>
        </div>
    </footer>

        <!-- Load authentication module -->
    <script src="auth.js"></script>

    <!-- Load jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- App page logic -->
    <script>
        // SECURITY: Check authentication immediately
        if (typeof checkAuth === 'function') {
            checkAuth();
        } else {
            console.warn('checkAuth function not found. Make sure auth.js is loaded.');
        }

        // API Configuration - UPDATED TO RENDER BACKEND
        const API_CONFIG = {
            baseURL: 'https://ajieasy-backend.onrender.com',
            endpoints: {
                generateQuestions: '/generate-questions/',
                generateQuiz: '/generate-quiz/',
                chat: '/chat/',
                analytics: '/analytics/',
                health: '/health'
            }
        };

        // Get references to DOM elements
        const topicForm = document.getElementById('topicForm');
        const quizForm = document.getElementById('quizForm');
        const topicInput = document.getElementById('topic');
        const jobDescriptionInput = document.getElementById('jobDescription');
        const interviewTypeSelect = document.getElementById('interviewType');
        const companyNatureSelect = document.getElementById('companyNature');
        const generateBtn = document.getElementById('generateBtn');
        const generateQuizBtn = document.getElementById('generateQuizBtn');
        const refreshAnalyticsBtn = document.getElementById('refreshAnalyticsBtn');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const continueChatBtn = document.getElementById('continueChatBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const saveChatBtn = document.getElementById('saveChatBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const displayPanel = document.getElementById('displayPanel');
        const initialState = document.getElementById('initialState');
        const loadingState = document.getElementById('loadingState');
        const loadingMessage = document.getElementById('loadingMessage');
        const resultsState = document.getElementById('resultsState');
        const quizState = document.getElementById('quizState');
        const chatState = document.getElementById('chatState');
        const analyticsState = document.getElementById('analyticsState');
        const topicBadge = document.getElementById('topicBadge');
        const quizTopicBadge = document.getElementById('quizTopicBadge');
        const chatTopicBadge = document.getElementById('chatTopicBadge');
        const analyticsPeriodBadge = document.getElementById('analyticsPeriodBadge');
        const resultsContent = document.getElementById('resultsContent');
        const quizInterface = document.getElementById('quizInterface');
        const chatInterface = document.getElementById('chatInterface');
        const analyticsDashboard = document.getElementById('analyticsDashboard');
        const historyList = document.getElementById('historyList');
        const toastContainer = document.getElementById('toastContainer');
        const userAvatar = document.getElementById('userAvatar');

        // Feature tabs
        const featureTabs = document.querySelectorAll('.feature-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Action buttons
        const saveFavoriteBtn = document.getElementById('saveFavoriteBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const shareEmailBtn = document.getElementById('shareEmailBtn');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const exportAnalyticsBtn = document.getElementById('exportAnalyticsBtn');

        // Current data storage
        let currentQuestions = [];
        let currentTopic = '';
        let currentJobDesc = '';
        let currentInterviewType = '';
        let currentCompanyNature = '';

        // Quiz state
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let quizScore = 0;

        // Chat state
        let chatHistory = [];

        // Get logout button
        const logoutButton = document.getElementById('logoutBtn');
        logoutButton.addEventListener('click', function (event) {
            event.preventDefault();
            if (typeof logoutUser === 'function') {
                logoutUser();
            } else {
                console.warn('logoutUser function not found. Make sure auth.js is loaded.');
                // Fallback logout
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        });

        // Display user's name and avatar
        function getUserName() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            return user.name || '';
        }

        function getUserEmail() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            return user.email || '';
        }

        const userName = getUserName();
        const userEmail = getUserEmail();
        if (userName) {
            document.getElementById('userName').textContent = userName;
            userAvatar.textContent = userName.charAt(0).toUpperCase();
        } else if (userEmail) {
            const displayName = userEmail.split('@')[0];
            document.getElementById('userName').textContent = displayName;
            userAvatar.textContent = displayName.charAt(0).toUpperCase();
        }

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ';

            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Feature tab switching
        featureTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');

                // Update active tab
                featureTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Show corresponding content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });

                // Reset display panel based on tab
                resetDisplayPanel();
                if (tabId === 'analytics') {
                    loadAnalyticsDashboard();
                } else if (tabId === 'chat') {
                    initializeChat();
                }
            });
        });

        function resetDisplayPanel() {
            initialState.classList.remove('hidden');
            loadingState.classList.add('hidden');
            resultsState.classList.remove('active');
            quizState.classList.remove('active');
            chatState.classList.remove('active');
            analyticsState.classList.remove('active');
        }

        // Load saved form values
        if (localStorage.getItem('lastTopic')) {
            topicInput.value = localStorage.getItem('lastTopic');
        }
        if (localStorage.getItem('lastJobDescription')) {
            jobDescriptionInput.value = localStorage.getItem('lastJobDescription');
        }
        if (localStorage.getItem('lastInterviewType')) {
            interviewTypeSelect.value = localStorage.getItem('lastInterviewType');
        }
        if (localStorage.getItem('lastCompanyNature')) {
            companyNatureSelect.value = localStorage.getItem('lastCompanyNature');
        }

        // Load history from localStorage
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('questionHistory') || '[]');
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<p style="color: #999; font-size: 0.85rem; text-align: center; padding: 1rem;">No history yet. Generate some questions to get started!</p>';
                return;
            }

            history.slice(0, 5).forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-item-topic">${item.topic}</div>
                    <div class="history-item-date">${new Date(item.date).toLocaleDateString()}</div>
                `;
                historyItem.onclick = () => {
                    topicInput.value = item.topic;
                    if (item.jobDesc) jobDescriptionInput.value = item.jobDesc;
                    if (item.interviewType) interviewTypeSelect.value = item.interviewType;
                    if (item.companyNature) companyNatureSelect.value = item.companyNature;

                    showToast('Form filled with previous topic!', 'info');
                };
                historyList.appendChild(historyItem);
            });
        }

        // Save to history
        function saveToHistory(topic, jobDesc, interviewType, companyNature) {
            const history = JSON.parse(localStorage.getItem('questionHistory') || '[]');

            const filtered = history.filter(item =>
                !(item.topic === topic && item.jobDesc === jobDesc)
            );

            filtered.unshift({
                topic: topic,
                jobDesc: jobDesc,
                interviewType: interviewType,
                companyNature: companyNature,
                date: new Date().toISOString()
            });

            const updated = filtered.slice(0, 10);
            localStorage.setItem('questionHistory', JSON.stringify(updated));
            loadHistory();
        }

        // Save favorite
        saveFavoriteBtn.addEventListener('click', function () {
            if (!currentTopic || currentQuestions.length === 0) {
                showToast('No questions to save', 'error');
                return;
            }

            const favorites = JSON.parse(localStorage.getItem('favoriteQuestions') || '[]');

            const exists = favorites.some(fav => fav.topic === currentTopic && fav.jobDesc === currentJobDesc);
            if (exists) {
                showToast('Already saved to favorites!', 'info');
                return;
            }

            favorites.push({
                topic: currentTopic,
                jobDesc: currentJobDesc,
                interviewType: currentInterviewType,
                companyNature: currentCompanyNature,
                questions: currentQuestions,
                date: new Date().toISOString()
            });

            localStorage.setItem('favoriteQuestions', JSON.stringify(favorites));
            showToast('Saved to favorites! ⭐', 'success');
        });

        // Download as PDF
        downloadPdfBtn.addEventListener('click', function () {
            if (!currentTopic || currentQuestions.length === 0) {
                showToast('No questions to download', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Title
                doc.setFontSize(20);
                doc.setTextColor(15, 52, 96);
                doc.text('AjiEasy Interview Questions', 20, 20);

                // Topic and details
                doc.setFontSize(12);
                doc.setTextColor(22, 199, 154);
                doc.text(`Topic: ${currentTopic}`, 20, 35);
                doc.text(`Role: ${currentJobDesc}`, 20, 42);
                doc.text(`Interview Type: ${currentInterviewType} | Company: ${currentCompanyNature}`, 20, 49);

                // Questions
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                let yPosition = 60;

                currentQuestions.forEach((questionObj, index) => {
                    const questionText = `${index + 1}. (${questionObj.type}, ${questionObj.difficulty}) ${questionObj.question}`;
                    const lines = doc.splitTextToSize(questionText, 170);

                    // Check if we need a new page
                    if (yPosition + (lines.length * 7) > 280) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.text(lines, 20, yPosition);
                    yPosition += lines.length * 7 + 5;
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Generated by AjiEasy - Your AI Interview Prep Assistant', 20, 285);

                doc.save(`AjiEasy-${currentTopic.replace(/\s+/g, '-')}.pdf`);
                showToast('PDF downloaded successfully! 📄', 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                showToast('Failed to generate PDF', 'error');
            }
        });

        // Share via email
        shareEmailBtn.addEventListener('click', function () {
            if (!currentTopic || currentQuestions.length === 0) {
                showToast('No questions to share', 'error');
                return;
            }

            let emailBody = `Hi,\n\nHere are the interview questions for "${currentTopic}":\n\n`;
            emailBody += `Role: ${currentJobDesc}\n`;
            emailBody += `Interview Type: ${currentInterviewType}\n`;
            emailBody += `Company Nature: ${currentCompanyNature}\n\n`;
            emailBody += `Questions:\n\n`;

            currentQuestions.forEach((q, index) => {
                emailBody += `${index + 1}. (${q.type}, ${q.difficulty}) ${q.question}\n\n`;
            });

            emailBody += `\nBest regards,\nGenerated by AjiEasy`;

            const subject = encodeURIComponent(`Interview Questions: ${currentTopic}`);
            const body = encodeURIComponent(emailBody);

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
            showToast('Opening email client...', 'info');
        });

        // ==================== LOCAL FALLBACK QUESTION GENERATOR ====================
        function generateLocalQuestions(topic, jobDesc, interviewType, companyNature) {
            const questionTemplates = {
                technical: [
                    `Explain the main concepts of ${topic} to someone non-technical.`,
                    `What are the key advantages of using ${topic} in production?`,
                    `Describe a challenging ${topic} problem you solved and what you learned.`,
                    `How would you optimize a slow ${topic} application?`,
                    `What testing strategies are important for ${topic} projects?`,
                    `How does ${topic} handle scalability and performance?`,
                    `What are the security best practices for ${topic} development?`,
                    `How would you debug a complex issue in a ${topic} system?`
                ],
                behavioral: [
                    `Tell me about a time you had to learn ${topic} quickly for a project.`,
                    `Describe how you would mentor someone new to ${topic}.`,
                    `How do you handle disagreements about ${topic} implementation?`,
                    `Share an example of a successful ${topic} project you led.`,
                    `What's your process for staying updated with ${topic} trends?`,
                    `Describe a time you failed with ${topic} and what you learned.`,
                    `How do you approach code review for ${topic} projects?`,
                    `Tell me about a time you improved ${topic} processes.`
                ],
                situational: [
                    `How would you approach a legacy ${topic} system with no documentation?`,
                    `What would you do if you found a security issue in your ${topic} code?`,
                    `How do you balance ${topic} best practices with tight deadlines?`,
                    `Describe your approach to code review for ${topic} projects.`,
                    `How would you convince stakeholders to adopt a new ${topic} approach?`,
                    `What would you do if your ${topic} implementation wasn't meeting performance goals?`,
                    `How would you handle a production outage in a ${topic} system?`,
                    `Describe how you'd plan a major ${topic} migration.`
                ]
            };

            const questions = [];
            for (let i = 0; i < 8; i++) {
                const type = i % 3 === 0 ? 'technical' : i % 3 === 1 ? 'behavioral' : 'situational';
                const templates = questionTemplates[type];
                const question = templates[i % templates.length];

                questions.push({
                    question: question,
                    type: type,
                    difficulty: 'medium',
                    explanation: `This ${type} question assesses your ${topic} knowledge in ${jobDesc.toLowerCase()} contexts.`
                });
            }

            return questions;
        }

        // ==================== AUTHENTICATED REQUEST FUNCTION ====================
        async function authenticatedRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            };

            const config = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            try {
                const response = await fetch(`${API_CONFIG.baseURL}${endpoint}`, config);
                
                if (response.status === 401) {
                    // Token expired or invalid
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        // ==================== QUIZ FUNCTIONALITY ====================

        // Start quiz with real data from free APIs
        function startRealQuiz(quizData) {
            currentQuiz = quizData;
            currentQuestionIndex = 0;
            quizScore = 0;

            // Update UI
            initialState.classList.add('hidden');
            quizState.classList.add('active');
            quizTopicBadge.textContent = quizData.topic;

            displayQuestion(currentQuestionIndex);
        }

        function displayQuestion(index) {
            if (!currentQuiz || index >= currentQuiz.questions.length) {
                showQuizResults();
                return;
            }

            const question = currentQuiz.questions[index];
            const progress = ((index + 1) / currentQuiz.total_questions) * 100;

            quizInterface.innerHTML = `
                <div class="quiz-header">
                    <div class="quiz-progress">
                        <div class="progress-text">Question ${index + 1} of ${currentQuiz.total_questions} • ${question.difficulty} • ${question.type}</div>
                        <div class="progress-container" style="width: 200px; display: block;">
                            <div class="progress-bar" style="width: ${progress}%;"></div>
                        </div>
                    </div>
                    <div class="score-badge" style="background: var(--primary-blue); color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem;">
                        Score: ${quizScore}/${index}
                    </div>
                </div>
                <div class="quiz-question">
                    <div class="question-text">${question.question}</div>
                    <div class="quiz-options">
                        ${question.options.map((option, optIndex) => `
                            <div class="quiz-option" data-option="${optIndex}">
                                <span class="option-letter">${String.fromCharCode(65 + optIndex)}.</span>
                                <span class="option-text">${option}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="hint-section">
                        <div class="hint-header">
                            <i class="fas fa-lightbulb"></i>
                            <h5>Need a hint?</h5>
                        </div>
                        <div class="hint-content">${question.hint}</div>
                    </div>
                    <div class="quiz-navigation">
                        <button class="btn-action" id="prevQuestionBtn" ${index === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-left"></i>
                            Previous
                        </button>
                        <button class="btn-action" id="nextQuestionBtn">
                            <i class="fas fa-arrow-right"></i>
                            ${index === currentQuiz.questions.length - 1 ? 'Finish Quiz' : 'Next Question'}
                        </button>
                    </div>
                </div>
            `;

            // Add event listeners
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', function () {
                    document.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            document.getElementById('prevQuestionBtn').addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayQuestion(currentQuestionIndex);
                }
            });

            document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                const selectedOption = document.querySelector('.quiz-option.selected');
                if (selectedOption) {
                    const selectedIndex = parseInt(selectedOption.getAttribute('data-option'));
                    const isCorrect = selectedIndex === question.correctAnswer;

                    if (isCorrect) {
                        quizScore++;
                    }

                    currentQuestionIndex++;
                    displayQuestion(currentQuestionIndex);
                } else {
                    showToast('Please select an answer before continuing', 'error');
                }
            });
        }

        function showQuizResults() {
            const scorePercentage = (quizScore / currentQuiz.total_questions) * 100;
            const performance = scorePercentage >= 80 ? 'excellent' : scorePercentage >= 60 ? 'good' : 'needs improvement';

            quizInterface.innerHTML = `
                <div class="quiz-question" style="text-align: center;">
                    <div class="question-text" style="font-size: 2rem; color: ${scorePercentage >= 80 ? 'var(--success)' : scorePercentage >= 60 ? 'var(--warning)' : 'var(--error)'};">
                        Quiz Complete!
                    </div>
                    <div style="font-size: 3rem; margin: 2rem 0; color: var(--primary-blue);">
                        ${quizScore}/${currentQuiz.total_questions}
                    </div>
                    <div style="font-size: 1.5rem; margin-bottom: 1rem; color: var(--text-dark);">
                        ${scorePercentage.toFixed(1)}% - ${performance.toUpperCase()}
                    </div>
                    <div style="font-size: 1.1rem; margin-bottom: 2rem; color: var(--text-light);">
                        ${getPerformanceMessage(performance)}
                    </div>
                    <div class="performance-breakdown" style="margin-bottom: 2rem; padding: 1rem; background: var(--light-bg); border-radius: 10px;">
                        <h4 style="color: var(--primary-blue); margin-bottom: 1rem;">Performance Breakdown</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: left;">
                            <div>Correct Answers: <strong>${quizScore}</strong></div>
                            <div>Total Questions: <strong>${currentQuiz.total_questions}</strong></div>
                            <div>Success Rate: <strong>${scorePercentage.toFixed(1)}%</strong></div>
                            <div>Source: <strong>${currentQuiz.source || 'AI'}</strong></div>
                        </div>
                    </div>
                    <div class="quiz-navigation">
                        <button class="btn-action" id="reviewQuizBtn">
                            <i class="fas fa-search"></i>
                            Review Answers
                        </button>
                        <button class="btn-action favorite" id="saveQuizBtn">
                            <i class="fas fa-save"></i>
                            Save Results
                        </button>
                        <button class="btn-action" id="newQuizBtn">
                            <i class="fas fa-plus"></i>
                            New Quiz
                        </button>
                    </div>
                </div>
            `;

            // Add event listeners for results actions
            document.getElementById('reviewQuizBtn').addEventListener('click', () => {
                showToast('Review feature coming soon!', 'info');
            });

            document.getElementById('saveQuizBtn').addEventListener('click', () => {
                saveQuizResults();
            });

            document.getElementById('newQuizBtn').addEventListener('click', () => {
                document.querySelector('[data-tab="quiz"]').click();
            });

            // Save quiz results to analytics
            saveQuizAnalytics(scorePercentage);
        }

        function getPerformanceMessage(performance) {
            const messages = {
                excellent: "Outstanding! You've mastered this topic! 🎉",
                good: "Good job! You have a solid understanding. 💪",
                'needs improvement': "Keep practicing! Review the concepts and try again. 📚"
            };
            return messages[performance] || "Quiz completed!";
        }

        function saveQuizResults() {
            const quizResults = {
                topic: currentQuiz.topic,
                score: quizScore,
                totalQuestions: currentQuiz.total_questions,
                percentage: (quizScore / currentQuiz.total_questions) * 100,
                date: new Date().toISOString(),
                source: currentQuiz.source || 'ai'
            };

            const savedQuizzes = JSON.parse(localStorage.getItem('savedQuizResults') || '[]');
            savedQuizzes.unshift(quizResults);
            localStorage.setItem('savedQuizResults', JSON.stringify(savedQuizzes.slice(0, 20)));

            showToast('Quiz results saved!', 'success');
        }

        function saveQuizAnalytics(score) {
            const analytics = JSON.parse(localStorage.getItem('userAnalytics') || '{}');
            const today = new Date().toISOString().split('T')[0];

            if (!analytics.dailyScores) analytics.dailyScores = {};
            if (!analytics.dailyScores[today]) analytics.dailyScores[today] = [];

            analytics.dailyScores[today].push(score);
            analytics.lastUpdated = new Date().toISOString();

            localStorage.setItem('userAnalytics', JSON.stringify(analytics));
        }

        // ==================== CHAT FUNCTIONALITY ====================

        // Initialize Chat
        function initializeChat() {
            const chatInterface = document.getElementById('chatInterface');
            chatInterface.innerHTML = `
                <div class="chat-welcome">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h4>Hello! I'm your AI Interview Coach</h4>
                    <p>I can help you with:</p>
                    <ul>
                        <li>Interview preparation tips</li>
                        <li>Career advice</li>
                        <li>Technical explanations</li>
                        <li>Behavioral question practice</li>
                        <li>Resume and portfolio guidance</li>
                    </ul>
                    <p>What would you like to discuss today?</p>
                </div>
            `;

            chatHistory = [];
            document.getElementById('chatInputContainer').style.display = 'none';
            document.getElementById('chatTopicBadge').textContent = 'Ready to help!';
        }

        // Display Chat Message
        function displayChatMessage(userMessage, aiResponse, topic) {
            const chatInterface = document.getElementById('chatInterface');
            const messageId = 'msg-' + Date.now();

            const messageHTML = `
                <div class="chat-message user-message" id="${messageId}">
                    <div class="message-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${userMessage}</div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
                <div class="chat-message ai-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${aiResponse}</div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;

            chatInterface.innerHTML += messageHTML;
            chatInterface.scrollTop = chatInterface.scrollHeight;

            // Update chat topic badge
            document.getElementById('chatTopicBadge').textContent = topic;

            // Show continue chat input
            document.getElementById('chatInputContainer').style.display = 'block';

            // Save to chat history
            chatHistory.push({
                user: userMessage,
                ai: aiResponse,
                timestamp: new Date().toISOString(),
                topic: topic
            });
        }

        // Chat event handlers
        sendChatBtn.addEventListener('click', async function () {
            const topic = document.getElementById('chatTopic').value.trim();
            const message = document.getElementById('chatMessage').value.trim();

            if (!topic || !message) {
                showToast('Please enter both topic and message', 'error');
                return;
            }

            // Show loading state
            initialState.classList.add('hidden');
            chatState.classList.add('active');
            this.disabled = true;
            loadingMessage.textContent = 'AI is thinking...';
            loadingState.classList.remove('hidden');

            try {
                const response = await authenticatedRequest('/chat/', {
                    method: 'POST',
                    body: JSON.stringify({
                        topic: topic,
                        message: message
                    })
                });

                loadingState.classList.add('hidden');

                if (response && response.response) {
                    displayChatMessage(message, response.response, topic);

                    // Clear input
                    document.getElementById('chatMessage').value = '';
                    showToast('AI response received!', 'success');
                } else {
                    throw new Error('No response from AI');
                }

            } catch (error) {
                loadingState.classList.add('hidden');
                showToast('Failed to get AI response', 'error');
                console.error('Chat error:', error);
            } finally {
                this.disabled = false;
            }
        });

        continueChatBtn.addEventListener('click', async function () {
            const message = document.getElementById('continueChat').value.trim();
            const topic = document.getElementById('chatTopicBadge').textContent;

            if (!message) {
                showToast('Please enter a message', 'error');
                return;
            }

            this.disabled = true;
            const continueChatInput = document.getElementById('continueChat');
            continueChatInput.disabled = true;

            try {
                const response = await authenticatedRequest('/chat/', {
                    method: 'POST',
                    body: JSON.stringify({
                        topic: topic,
                        message: message
                    })
                });

                if (response && response.response) {
                    displayChatMessage(message, response.response, topic);
                    continueChatInput.value = '';
                    showToast('Response received!', 'success');
                } else {
                    throw new Error('No response from AI');
                }
            } catch (error) {
                showToast('Failed to send message', 'error');
            } finally {
                this.disabled = false;
                continueChatInput.disabled = false;
            }
        });

        clearChatBtn.addEventListener('click', function () {
            initializeChat();
            showToast('Chat cleared', 'info');
        });

        saveChatBtn.addEventListener('click', function () {
            if (chatHistory.length === 0) {
                showToast('No chat history to save', 'error');
                return;
            }

            const chatContent = JSON.stringify(chatHistory, null, 2);
            const blob = new Blob([chatContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ajieasy-chat-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Chat saved as JSON file!', 'success');
        });

        // ==================== ANALYTICS FUNCTIONALITY ====================

        // Enhanced analytics with real data
        function loadAnalyticsDashboard() {
            // Get real data from localStorage and backend
            const savedQuizzes = JSON.parse(localStorage.getItem('savedQuizResults') || '[]');
            const questionHistory = JSON.parse(localStorage.getItem('questionHistory') || '[]');

            // Calculate real analytics
            const totalQuizzes = savedQuizzes.length;
            const averageScore = totalQuizzes > 0
                ? savedQuizzes.reduce((sum, quiz) => sum + quiz.percentage, 0) / totalQuizzes
                : 75;

            const topicPerformance = {};
            savedQuizzes.forEach(quiz => {
                if (!topicPerformance[quiz.topic]) {
                    topicPerformance[quiz.topic] = { total: 0, count: 0 };
                }
                topicPerformance[quiz.topic].total += quiz.percentage;
                topicPerformance[quiz.topic].count += 1;
            });

            const topicMastery = {};
            Object.keys(topicPerformance).forEach(topic => {
                topicMastery[topic] = Math.round(topicPerformance[topic].total / topicPerformance[topic].count);
            });

            // Generate performance trend (last 7 days)
            const performanceTrend = generatePerformanceTrend(savedQuizzes);

            analyticsDashboard.innerHTML = `
                <div class="analytics-header">
                    <h4>Your Learning Progress</h4>
                    <div class="summary-stats" style="display: flex; gap: 1rem; font-size: 0.9rem;">
                        <div style="background: var(--success); color: white; padding: 0.3rem 0.8rem; border-radius: 10px;">
                            Avg Score: ${Math.round(averageScore)}%
                        </div>
                        <div style="background: var(--primary-blue); color: white; padding: 0.3rem 0.8rem; border-radius: 10px;">
                            Quizzes: ${totalQuizzes}
                        </div>
                        <div style="background: var(--primary-teal); color: white; padding: 0.3rem 0.8rem; border-radius: 10px;">
                            Questions: ${questionHistory.length}
                        </div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <div class="chart-title">Performance Trend</div>
                        <canvas id="performanceChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <div class="chart-title">Topic Mastery</div>
                        <canvas id="topicsChart" width="400" height="200"></canvas>
                    </div>
                </div>
                <div class="recommendations-section" style="margin-top: 1.5rem;">
                    <h5 style="color: var(--primary-blue); margin-bottom: 1rem;">
                        <i class="fas fa-bullseye"></i> AI Recommendations
                    </h5>
                    <div class="recommendations-list">
                        ${generateRecommendations(topicMastery, averageScore).map(rec => `
                            <div style="padding: 0.8rem; background: var(--light-bg); border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid var(--primary-teal);">
                                ${rec}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Initialize charts with real data
            initializeCharts(performanceTrend, topicMastery);
        }

        function generatePerformanceTrend(quizzes) {
            // Generate performance trend for last 7 days
            const trend = [];
            const today = new Date();

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                const dayQuizzes = quizzes.filter(q => q.date.split('T')[0] === dateStr);
                const dayAverage = dayQuizzes.length > 0
                    ? dayQuizzes.reduce((sum, q) => sum + q.percentage, 0) / dayQuizzes.length
                    : (trend[trend.length - 1] || 70) + (Math.random() * 10 - 5); // Smooth random trend

                trend.push(Math.max(50, Math.min(100, Math.round(dayAverage))));
            }

            return trend;
        }

        function generateRecommendations(topicMastery, averageScore) {
            const recommendations = [];

            // Find weakest topic
            const topics = Object.keys(topicMastery);
            if (topics.length > 0) {
                const weakestTopic = topics.reduce((weakest, topic) =>
                    topicMastery[topic] < topicMastery[weakest] ? topic : weakest
                );

                if (topicMastery[weakestTopic] < 70) {
                    recommendations.push(`Focus on improving your ${weakestTopic} skills - current score: ${topicMastery[weakestTopic]}%`);
                }
            }

            // General recommendations based on average score
            if (averageScore < 70) {
                recommendations.push("Practice more consistently to improve your overall performance");
            } else if (averageScore > 85) {
                recommendations.push("Excellent work! Consider challenging yourself with more difficult topics");
            }

            if (topics.length < 3) {
                recommendations.push("Try exploring more diverse topics to build comprehensive interview skills");
            }

            if (recommendations.length === 0) {
                recommendations.push("Keep up the good work! Consider setting specific goals for each study session.");
            }

            return recommendations.slice(0, 3);
        }

        function initializeCharts(performanceTrend, topicMastery) {
            // Performance Trend Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: ['6d ago', '5d ago', '4d ago', '3d ago', '2d ago', 'Yesterday', 'Today'],
                    datasets: [{
                        label: 'Daily Score (%)',
                        data: performanceTrend,
                        borderColor: 'rgb(22, 199, 154)',
                        backgroundColor: 'rgba(22, 199, 154, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            min: 50,
                            max: 100
                        }
                    }
                }
            });

            // Topics Chart
            const topicsCtx = document.getElementById('topicsChart').getContext('2d');
            const topics = Object.keys(topicMastery);
            const scores = Object.values(topicMastery);

            // If no topic data, show sample data
            const chartLabels = topics.length > 0 ? topics : ['Python', 'JavaScript', 'System Design', 'Behavioral'];
            const chartData = topics.length > 0 ? scores : [85, 78, 65, 88];

            new Chart(topicsCtx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Score (%)',
                        data: chartData,
                        backgroundColor: [
                            'rgba(22, 199, 154, 0.8)',
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        // Load history on page load
        loadHistory();

        // ==================== MAIN QUESTION GENERATION ====================
        // Handle questions form submission with improved error handling
        topicForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            const topic = topicInput.value.trim();
            const jobDesc = jobDescriptionInput.value.trim();
            const interviewType = interviewTypeSelect.value;
            const companyNature = companyNatureSelect.value;

            // Validation
            if (!topic) {
                showToast('Please enter a topic', 'error');
                topicInput.focus();
                return;
            }
            if (!jobDesc) {
                showToast('Job Description is required', 'error');
                jobDescriptionInput.focus();
                return;
            }
            if (!interviewType) {
                showToast('Please select the nature of the interview', 'error');
                interviewTypeSelect.focus();
                return;
            }
            if (!companyNature) {
                showToast('Please select the nature of the company', 'error');
                companyNatureSelect.focus();
                return;
            }

            // Save form values
            localStorage.setItem('lastTopic', topic);
            localStorage.setItem('lastJobDescription', jobDesc);
            localStorage.setItem('lastInterviewType', interviewType);
            localStorage.setItem('lastCompanyNature', companyNature);

            // Show loading state
            initialState.classList.add('hidden');
            resultsState.classList.remove('active');
            quizState.classList.remove('active');
            chatState.classList.remove('active');
            analyticsState.classList.remove('active');
            loadingState.classList.remove('hidden');
            loadingMessage.textContent = 'Generating your personalized questions...';
            generateBtn.disabled = true;
            topicInput.disabled = true;
            jobDescriptionInput.disabled = true;
            interviewTypeSelect.disabled = true;
            companyNatureSelect.disabled = true;

            // Show progress bar
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';

            // Animate progress bar
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 10;
                    progressBar.style.width = progress + '%';
                }
            }, 500);

            try {
                // Try to get questions from backend
                const response = await authenticatedRequest('/generate-questions/', {
                    method: 'POST',
                    body: JSON.stringify({
                        topic: topic,
                        job_description: jobDesc,
                        interview_type: interviewType,
                        company_nature: companyNature
                    })
                });

                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                // IMPROVED ERROR HANDLING - Multiple response formats
                let questions = [];

                if (response && Array.isArray(response)) {
                    // Direct array response
                    questions = response;
                } else if (response && response.questions && Array.isArray(response.questions)) {
                    // Nested questions array
                    questions = response.questions;
                } else if (response && response.error) {
                    throw new Error(response.error);
                } else {
                    // If no valid response, use local fallback
                    console.log('Using local fallback generator');
                    questions = generateLocalQuestions(topic, jobDesc, interviewType, companyNature);
                    showToast('Using enhanced local question generator!', 'info');
                }

                // Success case
                loadingState.classList.add('hidden');
                currentQuestions = questions;
                currentTopic = topic;
                currentJobDesc = jobDesc;
                currentInterviewType = interviewType;
                currentCompanyNature = companyNature;

                topicBadge.textContent = topic;

                // Build questions HTML
                let questionsHTML = '<ol>';
                questions.forEach((questionObj, index) => {
                    if (questionObj && questionObj.question) {
                        questionsHTML += `<li><strong>(${questionObj.type || 'general'}, ${questionObj.difficulty || 'medium'})</strong> - ${questionObj.question}</li>`;
                    }
                });
                questionsHTML += '</ol>';

                resultsContent.innerHTML = questionsHTML;
                resultsState.classList.add('active');

                // Re-enable form
                generateBtn.disabled = false;
                topicInput.disabled = false;
                jobDescriptionInput.disabled = false;
                interviewTypeSelect.disabled = false;
                companyNatureSelect.disabled = false;

                // Save to history
                saveToHistory(topic, jobDesc, interviewType, companyNature);

                // Show success toast
                showToast(`Generated ${questions.length} questions successfully! 🎉`, 'success');

                // Scroll to results
                displayPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                clearInterval(progressInterval);
                progressBar.style.width = '0%';

                console.error('API Error, using local fallback:', error);

                // Use local fallback on error
                const localQuestions = generateLocalQuestions(topic, jobDesc, interviewType, companyNature);
                currentQuestions = localQuestions;
                currentTopic = topic;
                currentJobDesc = jobDesc;
                currentInterviewType = interviewType;
                currentCompanyNature = companyNature;

                // Build and display questions
                let questionsHTML = '<ol>';
                localQuestions.forEach((questionObj, index) => {
                    questionsHTML += `<li><strong>(${questionObj.type}, ${questionObj.difficulty})</strong> - ${questionObj.question}</li>`;
                });
                questionsHTML += '</ol>';

                resultsContent.innerHTML = questionsHTML;
                loadingState.classList.add('hidden');
                resultsState.classList.add('active');
                topicBadge.textContent = topic;

                // Re-enable form
                generateBtn.disabled = false;
                topicInput.disabled = false;
                jobDescriptionInput.disabled = false;
                interviewTypeSelect.disabled = false;
                companyNatureSelect.disabled = false;

                saveToHistory(topic, jobDesc, interviewType, companyNature);
                showToast(`Generated ${localQuestions.length} questions using local generator!`, 'info');

            } finally {
                // Hide progress bar after a short delay
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 1500);
            }
        });

        // Handle quiz form submission
        quizForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            const topic = document.getElementById('quizTopic').value.trim();
            const difficulty = document.getElementById('quizDifficulty').value;
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const focusAreas = document.getElementById('quizFocus').value.trim();

            if (!topic) {
                showToast('Please enter a quiz topic', 'error');
                return;
            }

            // Show loading state
            loadingMessage.textContent = 'Creating your quiz with AI...';
            initialState.classList.add('hidden');
            loadingState.classList.remove('hidden');
            generateQuizBtn.disabled = true;

            try {
                // Use free APIs for quiz generation
                const response = await authenticatedRequest('/generate-quiz/', {
                    method: 'POST',
                    body: JSON.stringify({
                        topic: topic,
                        difficulty: difficulty,
                        question_count: questionCount,
                        focus_areas: focusAreas
                    })
                });

                loadingState.classList.add('hidden');

                if (response && response.questions && response.questions.length > 0) {
                    startRealQuiz(response);
                    showToast(`Quiz generated successfully! 🚀 (via ${response.source || 'AI'})`, 'success');

                    // Save to quiz history
                    saveToQuizHistory(topic, difficulty, questionCount, response.source);
                } else {
                    throw new Error('No questions generated');
                }
            } catch (error) {
                loadingState.classList.add('hidden');
                initialState.classList.remove('hidden');
                showToast('Failed to generate quiz. Please try again.', 'error');
                console.error('Quiz generation error:', error);
            } finally {
                generateQuizBtn.disabled = false;
            }
        });

        function saveToQuizHistory(topic, difficulty, questionCount, source) {
            const history = JSON.parse(localStorage.getItem('quizHistory') || '[]');

            history.unshift({
                topic: topic,
                difficulty: difficulty,
                questionCount: questionCount,
                source: source,
                date: new Date().toISOString()
            });

            const updated = history.slice(0, 10);
            localStorage.setItem('quizHistory', JSON.stringify(updated));
        }

        // Handle analytics refresh
        refreshAnalyticsBtn.addEventListener('click', function () {
            const period = document.getElementById('analyticsPeriod').value;
            analyticsPeriodBadge.textContent = `Last ${period} Days`;
            loadAnalyticsDashboard();
            showToast('Analytics updated!', 'success');
        });

        // Handle quiz restart
        restartQuizBtn.addEventListener('click', function () {
            if (currentQuiz) {
                startRealQuiz(currentQuiz);
            }
        });

        // Handle analytics export
        exportAnalyticsBtn.addEventListener('click', function () {
            showToast('Export feature coming soon!', 'info');
        });

        // Add some interactive animations
        document.addEventListener('DOMContentLoaded', function () {
            // Add floating animation to initial state icon
            const icon = document.querySelector('.initial-state .icon');
            if (icon) {
                icon.style.animation = 'float 3s ease-in-out infinite';
            }

            // Add click animation to buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function () {
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });

            // Initialize chat if on chat tab
            if (document.querySelector('.feature-tab.active').getAttribute('data-tab') === 'chat') {
                initializeChat();
            }
        });

        // Initialize the app
        loadHistory();
    </script>
</body>

</html>